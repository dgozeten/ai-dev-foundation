# State Protocol — Primitives

These are the core data primitives that every State Protocol implementation MUST support.

---

## `requestId`

| Attribute | Value |
|---|---|
| **Purpose** | Uniquely identifies a single mutation attempt for idempotency |
| **Type** | UUID v4 (string) |
| **Generated by** | The caller (client, agent, script) |
| **Validated by** | The server — checks for prior execution of the same `requestId` |
| **Lifecycle** | Created at call time. Stored permanently. Never reused. |

**Rules:**
- If a mutation with the same `requestId` has already been processed, the server
  MUST return the original result — not re-execute.
- The `requestId` is the foundation of idempotency. Without it, retries are unsafe.

---

## `resourceId`

| Attribute | Value |
|---|---|
| **Purpose** | Identifies the specific resource being mutated |
| **Type** | UUID or composite key (string) |
| **Generated by** | The system on resource creation, or composed from business keys |
| **Validated by** | The server — must resolve to an existing resource (or trigger creation) |
| **Lifecycle** | Created when the resource is first created. Immutable thereafter. |

**Rules:**
- A `resourceId` MUST uniquely identify exactly one mutable resource.
- Composite keys (e.g., `unitId:date`) are valid when the resource identity
  is inherently multi-dimensional.

---

## `rev`

| Attribute | Value |
|---|---|
| **Purpose** | Tracks the current version of a resource after each mutation |
| **Type** | Monotonically increasing integer |
| **Generated by** | The server — incremented on every successful mutation |
| **Validated by** | N/A — `rev` is output-only in mutation responses |
| **Lifecycle** | Starts at 1 on creation. Increments by 1 on every successful write. |

**Rules:**
- The `rev` MUST increase on every successful mutation — no exceptions.
- The `rev` is returned in every mutation response so the caller can track state.
- The `rev` is never decremented, reset, or skipped.

---

## `expectedRev`

| Attribute | Value |
|---|---|
| **Purpose** | Enables optimistic concurrency — the caller declares which version they believe is current |
| **Type** | Integer (optional) |
| **Generated by** | The caller — set to the `rev` they last observed |
| **Validated by** | The server — if provided, must match the current `rev` or the mutation is rejected |
| **Lifecycle** | Optional per request. When present, it activates conflict detection. |

**Rules:**
- If `expectedRev` is provided and does not match the current `rev`, the server
  MUST reject the mutation with a conflict signal (e.g., HTTP 409).
- If `expectedRev` is omitted, the mutation proceeds without concurrency checks.
  This is acceptable for fire-and-forget writes but NOT recommended for user-facing operations.
- The server MUST NOT silently ignore a mismatched `expectedRev`.
